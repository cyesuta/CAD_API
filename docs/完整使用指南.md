# CAD_API 完整使用指南

## 📋 關於本文檔

本文檔整合了使用指南、CLI使用說明、使用文件監視方法等所有相關文檔，提供完整的使用說明。

## 目錄

1. [系統概述](#系統概述)
2. [環境要求](#環境要求)
3. [快速開始](#快速開始)
4. [命令格式](#命令格式)
5. [使用方式](#使用方式)
6. [進階功能](#進階功能)
7. [技術原理](#技術原理)
8. [疑難排解](#疑難排解)
9. [最佳實踐](#最佳實踐)
10. [限制與展望](#限制與展望)

---

## 系統概述

### 什麼是 CAD_API

CAD_API 是一個使用 AutoCAD .NET API 開發的控制工具，透過文件監視機制實現從外部程式控制 AutoCAD 進行繪圖操作。

### 核心架構

請參考 [README.md](../README.md#系統架構) 中的系統架構圖。

### 核心組件說明

1. **AutoCAD 插件（v3版本）**
   - 基於 .NET Framework 4.8
   - 實現 FileWatcher 監視命令文件
   - 提供 CADAPI_WATCH、CADAPI_BATCH 等命令
   - 自動解析並執行繪圖命令

2. **CLI 客戶端**
   - 基於 .NET 6.0
   - 使用 File.WriteAllText 寫入命令
   - 確保觸發 FileWatcher 事件
   - 自動尋找專案根目錄

3. **PowerShell 腳本**
   - 自動化批量命令執行
   - 實現必要的延遲控制（1秒）
   - 提供範例腳本模板

---

## 環境要求

請參考 [README.md](../README.md#環境需求) 查看詳細的環境要求。

---

## 快速開始

### 3 步驟立即使用

#### 步驟 1：加載插件
在 AutoCAD 2023 命令行：
```
NETLOAD
```
選擇檔案：`{CAD_API根目錄}\src\CAD_API.Plugin\bin\Debug\net48\CAD_API.Plugin.v3.dll`

#### 步驟 2：啟動監視器
```
CADAPI_WATCH
```
會顯示：
```
文件監視器已啟動。
監視文件：{CAD_API根目錄}\commands.txt
在該文件中寫入命令，AutoCAD 會自動執行。
```

#### 步驟 3：執行繪圖
在終端執行：
```bash
cd {CAD_API根目錄}
powershell -ExecutionPolicy Bypass -File draw\draw_three_squares_delay.ps1
```

您會看到 AutoCAD 自動繪製三個正方形！

---

## 命令格式

### 基本語法
```
DRAW LINE 起點X,起點Y 長度 方向
```

### 參數詳解

| 參數 | 說明 | 範例 |
|------|------|------|
| DRAW | 命令動作（目前只支援 DRAW） | DRAW |
| LINE | 繪圖類型（目前只支援 LINE） | LINE |
| 起點X,起點Y | 起始坐標 | 0,0 或 100,200 |
| 長度 | 線條長度，支援負值表示反向 | 2000 或 -1500 |
| 方向 | HORIZONTAL (H) 或 VERTICAL (V) | HORIZONTAL 或 H |

### 命令範例

```bash
# 基本直線
DRAW LINE 0,0 2000 HORIZONTAL      # 從原點向右畫 2000 單位
DRAW LINE 0,0 1500 VERTICAL        # 從原點向上畫 1500 單位

# 使用簡寫
DRAW LINE 100,100 1000 H           # 水平線
DRAW LINE 200,200 1000 V           # 垂直線

# 反向繪製（使用負值）
DRAW LINE 500,500 -1000 HORIZONTAL # 向左畫 1000 單位
DRAW LINE 500,500 -1000 VERTICAL   # 向下畫 1000 單位

# 繪製正方形
DRAW LINE 0,0 1000 HORIZONTAL      # 底邊
DRAW LINE 1000,0 1000 VERTICAL     # 右邊
DRAW LINE 1000,1000 -1000 HORIZONTAL # 頂邊
DRAW LINE 0,1000 -1000 VERTICAL    # 左邊
```

---

## 使用方式

### 方式 1：PowerShell 腳本（推薦）

最簡單的使用方式，適合批量繪圖：

```bash
# 使用預設腳本
powershell -ExecutionPolicy Bypass -File draw\draw_three_squares_delay.ps1

# 其他可用腳本
powershell -ExecutionPolicy Bypass -File draw\draw_v3_squares.ps1
```

### 方式 2：CLI 互動模式

適合單次測試或少量命令：

```bash
# 執行 CLI
{CAD_API根目錄}\src\CAD_API.CLI\bin\Debug\net6.0\CAD_API.CLI.exe

# 輸入命令
> DRAW LINE 0,0 2000 HORIZONTAL
> DRAW LINE 2000,0 2000 VERTICAL
> EXIT
```

### 方式 3：AutoCAD 批次模式

在 AutoCAD 內直接輸入多個命令：

```
CADAPI_BATCH
進入批次命令模式。輸入 EXIT 退出。
CAD> DRAW LINE 0,0 2000 HORIZONTAL
成功繪製直線: (0, 0) 到 (2000, 0)
CAD> DRAW LINE 2000,0 2000 VERTICAL
成功繪製直線: (2000, 0) 到 (2000, 2000)
CAD> EXIT
```

### 方式 4：創建自定義腳本

1. **複製模板**
   ```bash
   cp draw\draw_template.ps1 draw\my_drawing.ps1
   ```

2. **編輯命令列表**
   ```powershell
   $commands = @(
       "DRAW LINE 0,0 1000 HORIZONTAL",
       "DRAW LINE 1000,0 1000 VERTICAL",
       "DRAW LINE 1000,1000 -1000 HORIZONTAL",
       "DRAW LINE 0,1000 -1000 VERTICAL"
   )
   ```

3. **執行腳本**
   ```bash
   powershell -ExecutionPolicy Bypass -File draw\my_drawing.ps1
   ```

---

## 進階功能

### AutoCAD 命令清單

| 命令 | 功能 | 使用場景 |
|------|------|----------|
| CADAPI_WATCH | 啟動文件監視器 | 主要使用方式 |
| CADAPI_STOPWATCH | 停止文件監視器 | 結束工作時 |
| CADAPI_BATCH | 批次命令模式 | AutoCAD 內互動使用 |
| CADAPI | 單次命令執行 | 測試用 |
| CADLINE | 互動式繪製直線 | 手動繪圖 |

### 自動載入插件

讓 AutoCAD 啟動時自動載入插件：

1. 在 AutoCAD 中輸入：`APPLOAD`
2. 點擊「內容」
3. 添加 `CAD_API.Plugin.v3.dll` 到啟動載入清單

### 坐標系統說明

- 使用 AutoCAD 世界坐標系（WCS）
- X 軸：向右為正
- Y 軸：向上為正
- 單位：取決於 AutoCAD 圖面設定（通常為毫米）

---

## 技術原理

### FileWatcher 工作原理

1. **監視機制**
   - 使用 .NET FileSystemWatcher 類別
   - 監視 commands.txt 的 LastWrite 和 Size 變化
   - 底層使用 Windows ReadDirectoryChangesW API

2. **事件處理流程**
   ```
   文件變更 → 100ms 延遲 → 讀取內容 → 解析命令 → 執行繪圖 → 清空文件
   ```

3. **為什麼需要 1 秒延遲？**
   - FileWatcher 內部延遲：100ms
   - 文件 I/O 操作：~50ms
   - AutoCAD 命令執行：200-300ms
   - 安全餘量：確保穩定執行

### 為什麼必須使用 CLI.exe？

PowerShell 的文件寫入方式（Out-File、Set-Content）不保證觸發 FileSystemWatcher，因為：

1. **CLI.exe 使用的方法**
   ```csharp
   File.WriteAllText(filePath, content);
   ```
   - 原子性操作
   - 正確更新檔案時間戳
   - 觸發所有必要的系統事件

2. **PowerShell 的問題**
   - 可能使用緩衝寫入
   - 不保證更新所有檔案屬性
   - 某些情況下不觸發變更事件

---

## 疑難排解

### 常見問題與解決方案

#### 問題：插件無法載入
- ✅ 確認 AutoCAD 版本為 2023
- ✅ 確認 .NET Framework 4.8 已安裝
- ✅ 使用正確的 v3 版本 DLL
- ✅ 檢查檔案路徑是否正確

#### 問題：CADAPI_WATCH 命令未知
- ✅ 確認插件已成功載入（使用 NETLOAD）
- ✅ 確認使用 v3 版本（不是 v1 或 v2）
- ✅ 查看 AutoCAD 命令行是否有錯誤訊息

#### 問題：命令執行無反應
1. 確認 CADAPI_WATCH 已啟動並顯示監視訊息
2. 確認使用 CLI.exe 寫入命令（不是手動編輯）
3. 檢查 commands.txt 檔案是否存在於正確位置
4. 查看 AutoCAD 命令行輸出是否有錯誤

#### 問題：繪圖不完整（缺少某些線條）
- ✅ 增加命令間隔時間（確保 1 秒以上）
- ✅ 使用延遲版腳本（名稱含 delay）
- ✅ 逐條執行命令進行測試
- ✅ 檢查命令格式是否正確

#### 問題：FileWatcher 不觸發
1. **必須**通過 CLI.exe 寫入
2. 檢查防毒軟體是否阻擋檔案監視
3. 確認 commands.txt 路徑正確且有寫入權限
4. 嘗試刪除 commands.txt 後重新啟動監視器

---

## 最佳實踐

### 批量繪圖建議

1. **使用 PowerShell 腳本**
   - 易於管理命令序列
   - 可加入錯誤處理
   - 支援日誌記錄

2. **命令延遲設定**
   ```powershell
   foreach ($cmd in $commands) {
       $cmd | & $cliPath
       Start-Sleep -Seconds 1  # 關鍵！
   }
   ```

3. **測試策略**
   - 先用少量命令測試
   - 確認無誤後再執行大批量
   - 保存成功的腳本供重複使用

### 專案組織建議

```
draw/
├── templates/          # 腳本模板
├── examples/           # 範例腳本
├── my_projects/        # 自定義專案
└── README.md          # 腳本說明
```

### 錯誤處理範例

```powershell
try {
    $cmd | & $cliPath
    Write-Host "✓ 執行成功: $cmd" -ForegroundColor Green
} catch {
    Write-Host "✗ 執行失敗: $cmd" -ForegroundColor Red
    Write-Host $_.Exception.Message
}
```

---

## 限制與展望

### 當前限制

1. **功能限制**
   - 只支援 DRAW LINE 命令
   - 不支援圓、弧、文字等其他圖形
   - 無法設定顏色、線型、圖層

2. **通信限制**
   - 單向通信（無法獲取 AutoCAD 狀態）
   - 無法查詢圖形資訊
   - 沒有命令執行結果回饋

3. **性能限制**
   - 每個命令需要 1 秒延遲
   - 不適合即時互動應用
   - 大量命令執行較慢

### 未來可能的改進

1. **擴展圖形支援**
   - DRAW CIRCLE（圓）
   - DRAW ARC（弧）
   - DRAW TEXT（文字）
   - DRAW POLYLINE（多段線）

2. **增強功能**
   - 圖層管理
   - 顏色設定
   - 線型控制
   - 標註功能

3. **改進通信機制**
   - 雙向通信
   - 狀態查詢
   - 結果回饋
   - 錯誤處理

---

## 相關文檔

- **[README.md](../README.md)** - 專案總覽
- **[TOOLS.md](../TOOLS.md)** - 技術實現細節
- **[CHANGELOG.md](../CHANGELOG.md)** - 開發歷史記錄
- **[build.md](build.md)** - LLM 開發指南

---

## 快速參考卡

### 最常用命令
```bash
# AutoCAD 內
NETLOAD                    # 載入插件
CADAPI_WATCH              # 啟動監視
CADAPI_STOPWATCH          # 停止監視

# 終端內
cd {CAD_API根目錄}
powershell -ExecutionPolicy Bypass -File draw\draw_three_squares_delay.ps1
```

### 命令格式速查
```
DRAW LINE X,Y 長度 方向
DRAW LINE 0,0 1000 H      # 水平線
DRAW LINE 0,0 1000 V      # 垂直線
DRAW LINE 0,0 -1000 H     # 反向水平
DRAW LINE 0,0 -1000 V     # 反向垂直
```

---

最後更新：2025-01-25