# CAD_API 完整使用指南

## 📋 關於本文檔

本文檔整合了使用指南、CLI使用說明、使用文件監視方法等所有相關文檔，提供完整的使用說明。

## 目錄

1. [系統概述](#系統概述)
2. [環境要求](#環境要求)
3. [快速開始](#快速開始)
4. [命令格式](#命令格式)
5. [使用方式](#使用方式)
6. [進階功能](#進階功能)
7. [技術原理](#技術原理)
8. [疑難排解](#疑難排解)
9. [最佳實踐](#最佳實踐)
10. [限制與展望](#限制與展望)

---

## 系統概述

### 什麼是 CAD_API

CAD_API 是一個使用 AutoCAD .NET API 開發的控制工具，透過文件監視機制實現從外部程式控制 AutoCAD 進行繪圖操作。

### 核心架構

請參考 [README.md](../README.md#系統架構) 中的系統架構圖。

### 核心組件說明

1. **AutoCAD 插件（v3版本）**
   - 基於 .NET Framework 4.8
   - 實現 FileWatcher 監視命令文件
   - 提供 CADAPI_WATCH、CADAPI_BATCH 等命令
   - 自動解析並執行繪圖命令

2. **CLI 客戶端**
   - 基於 .NET 6.0
   - 使用 File.WriteAllText 寫入命令
   - 確保觸發 FileWatcher 事件
   - 自動尋找專案根目錄

3. **PowerShell 腳本**
   - 自動化批量命令執行
   - 實現必要的延遲控制（1秒）
   - 提供範例腳本模板

---

## 環境要求

請參考 [README.md](../README.md#環境需求) 查看詳細的環境要求。

---

## 快速開始

### 3 步驟立即使用

#### 步驟 1：加載插件
在 AutoCAD 命令行：
```
NETLOAD
```
選擇檔案：`{CAD_API根目錄}\src\CAD_API.Plugin\bin\Debug\net48\CAD_API.Plugin.v3.dll`

#### 步驟 2：啟動監視器
```
CADAPI_WATCH
```
會顯示：
```
文件監視器已啟動。
監視文件：{CAD_API根目錄}\commands.txt
在該文件中寫入命令，AutoCAD 會自動執行。
```

#### 步驟 3：執行繪圖
在終端執行：
```bash
cd {CAD_API根目錄}
powershell -ExecutionPolicy Bypass -File draw\draw_three_squares_delay.ps1
```

您會看到 AutoCAD 自動繪製三個正方形！

---

## 命令格式

### 命令格式說明

CAD_API 現已支援多種繪圖、選擇和修改命令。每個命令都有特定的語法格式。

### 支援的繪圖命令

| 命令類型 | 語法 | 說明 |
|---------|------|------|
| 直線 | `DRAW LINE 起點X,起點Y 長度 方向` | 方向：HORIZONTAL/H 或 VERTICAL/V |
| 圓形 | `DRAW CIRCLE 中心X,中心Y 半徑` | 繪製圓形 |
| 弧線 | `DRAW ARC 中心X,中心Y 半徑 起始角度 結束角度` | 角度單位：度 |
| 矩形 | `DRAW RECTANGLE 角點1X,角點1Y 角點2X,角點2Y` | 兩個對角點定義矩形 |
| 多段線 | `DRAW POLYLINE 點1X,點1Y 點2X,點2Y ...` | 至少需要兩個點 |
| 文字 | `DRAW TEXT X,Y 高度 "文字內容"` | 文字內容需用引號包圍 |
| 尺寸標註 | `DRAW DIMENSION 點1X,點1Y 點2X,點2Y` | 線性尺寸標註 |
| 填充 | `DRAW HATCH 圖案 比例 角度` | 需要先選擇邊界 |

### 選擇命令

| 命令 | 語法 | 說明 |
|------|------|------|
| 選擇所有 | `SELECT ALL` | 選擇圖面上所有物件 |
| 類型選擇 | `SELECT TYPE 類型` | 類型：LINE, CIRCLE, ARC, POLYLINE, TEXT, DIMENSION, HATCH |
| 窗口選擇 | `SELECT WINDOW 點1X,點1Y 點2X,點2Y` | 完全包含在窗口內的物件 |
| 交叉選擇 | `SELECT CROSSING 點1X,點1Y 點2X,點2Y` | 與窗口相交的物件 |
| 點選擇 | `SELECT POINT X,Y [容差]` | 預設容差為 10 單位 |
| 圖層選擇 | `SELECT LAYER 圖層名` | 選擇特定圖層的物件 |
| 清除選擇 | `SELECT CLEAR` | 清除當前選擇集 |

### 修改命令

| 命令 | 語法 | 說明 |
|------|------|------|
| 移動 | `MOVE 目標 偏移X,偏移Y` | 目標：LAST, SELECTED, ALL |
| 複製 | `COPY 目標 偏移X,偏移Y [數量]` | 預設複製 1 個 |
| 旋轉 | `ROTATE 目標 基點X,基點Y 角度` | 角度單位：度 |
| 縮放 | `SCALE 目標 基點X,基點Y 比例` | 比例：1.0 = 原始大小 |
| 刪除 | `DELETE 目標` | 刪除指定物件 |
| 鏡射 | `MIRROR 目標 點1X,點1Y 點2X,點2Y` | 兩點定義鏡射軸 |
| 偏移 | `OFFSET 目標 距離` | 向外偏移指定距離 |
| 修剪 | `TRIM 邊界物件 修剪點X,修剪點Y` | 修剪到邊界 |
| 延伸 | `EXTEND 邊界物件 延伸點X,延伸點Y` | 延伸到邊界 |

### 命令範例

```bash
# 基本繪圖
DRAW LINE 0,0 2000 HORIZONTAL      # 從原點向右畫 2000 單位
DRAW CIRCLE 1000,1000 500          # 在 (1000,1000) 畫半徑 500 的圓
DRAW RECTANGLE 0,0 2000,1500       # 畫矩形

# 選擇操作
SELECT TYPE CIRCLE                 # 選擇所有圓形
MOVE SELECTED 500,0                # 將選中的圓形向右移動 500
SELECT WINDOW 0,0 2000,2000        # 窗口選擇
COPY SELECTED 0,1000 3             # 複製選中物件向上 1000，共 3 份

# 組合操作
DRAW LINE 0,0 1000 H              # 畫線
SELECT LAST                       # 選擇最後繪製的物件
ROTATE SELECTED 0,0 45            # 旋轉 45 度

# 繪製正方形
DRAW LINE 0,0 1000 HORIZONTAL      # 底邊
DRAW LINE 1000,0 1000 VERTICAL     # 右邊
DRAW LINE 1000,1000 -1000 HORIZONTAL # 頂邊
DRAW LINE 0,1000 -1000 VERTICAL    # 左邊
```

### 重要注意事項

1. **命令間隔**：每個命令之間需要至少 1 秒的間隔，避免命令遺失
2. **尺寸標註文字**：DIMENSION 命令的文字大小取決於 AutoCAD 的當前尺寸樣式（DIMSTYLE）設定，可能需要調整以獲得適當的顯示效果
3. **坐標格式**：必須使用逗號分隔坐標，如 `100,200`，不可使用空格
4. **文字參數**：TEXT 命令中包含空格的文字必須用雙引號包圍，如 `"Hello World"`

---

## 使用方式

### 方式 1：PowerShell 腳本（推薦）

最簡單的使用方式，適合批量繪圖：

```bash
# 使用預設腳本
powershell -ExecutionPolicy Bypass -File draw\draw_three_squares_delay.ps1

# 其他可用腳本
powershell -ExecutionPolicy Bypass -File draw\draw_v3_squares.ps1
```

### 方式 2：CLI 互動模式

適合單次測試或少量命令：

```bash
# 執行 CLI
{CAD_API根目錄}\src\CAD_API.CLI\bin\Debug\net6.0\CAD_API.CLI.exe

# 輸入命令
> DRAW LINE 0,0 2000 HORIZONTAL
> DRAW LINE 2000,0 2000 VERTICAL
> EXIT
```

### 方式 3：AutoCAD 批次模式

在 AutoCAD 內直接輸入多個命令：

```
CADAPI_BATCH
進入批次命令模式。輸入 EXIT 退出。
CAD> DRAW LINE 0,0 2000 HORIZONTAL
成功繪製直線: (0, 0) 到 (2000, 0)
CAD> DRAW CIRCLE 1000,1000 500
成功繪製圓形: 中心 (1000, 1000), 半徑 500
CAD> SELECT TYPE CIRCLE
已選擇 1 個物件
CAD> MOVE SELECTED 500,0
成功移動 1 個物件
CAD> EXIT
```

### 方式 4：創建自定義腳本

1. **複製模板**
   ```bash
   cp draw\draw_template.ps1 draw\my_drawing.ps1
   ```

2. **編輯命令列表**
   ```powershell
   $commands = @(
       "DRAW LINE 0,0 1000 HORIZONTAL",
       "DRAW LINE 1000,0 1000 VERTICAL",
       "DRAW LINE 1000,1000 -1000 HORIZONTAL",
       "DRAW LINE 0,1000 -1000 VERTICAL"
   )
   ```

3. **執行腳本**
   ```bash
   powershell -ExecutionPolicy Bypass -File draw\my_drawing.ps1
   ```

---

## 進階功能

### AutoCAD 命令清單

| 命令 | 功能 | 使用場景 |
|------|------|----------|
| CADAPI_WATCH | 啟動文件監視器 | 主要使用方式 |
| CADAPI_STOPWATCH | 停止文件監視器 | 結束工作時 |
| CADAPI_BATCH | 批次命令模式 | AutoCAD 內互動使用 |
| CADAPI | 單次命令執行 | 測試用 |
| CADLINE | 互動式繪製直線 | 手動繪圖 |

### 自動載入插件

讓 AutoCAD 啟動時自動載入插件：

1. 在 AutoCAD 中輸入：`APPLOAD`
2. 點擊「內容」
3. 添加 `CAD_API.Plugin.v3.dll` 到啟動載入清單

### 坐標系統說明

- 使用 AutoCAD 世界坐標系（WCS）
- X 軸：向右為正
- Y 軸：向上為正
- 單位：取決於 AutoCAD 圖面設定（通常為毫米）

---

## 技術原理

### FileWatcher 工作原理

1. **監視機制**
   - 使用 .NET FileSystemWatcher 類別
   - 監視 commands.txt 的 LastWrite 和 Size 變化
   - 底層使用 Windows ReadDirectoryChangesW API

2. **事件處理流程**
   ```
   文件變更 → 100ms 延遲 → 讀取內容 → 解析命令 → 執行繪圖 → 清空文件
   ```

3. **為什麼需要 1 秒延遲？**
   - FileWatcher 內部延遲：100ms
   - 文件 I/O 操作：~50ms
   - AutoCAD 命令執行：200-300ms
   - 安全餘量：確保穩定執行

### 為什麼必須使用 CLI.exe？

PowerShell 的文件寫入方式（Out-File、Set-Content）不保證觸發 FileSystemWatcher，因為：

1. **CLI.exe 使用的方法**
   ```csharp
   File.WriteAllText(filePath, content);
   ```
   - 原子性操作
   - 正確更新檔案時間戳
   - 觸發所有必要的系統事件

2. **PowerShell 的問題**
   - 可能使用緩衝寫入
   - 不保證更新所有檔案屬性
   - 某些情況下不觸發變更事件

---

## 疑難排解

### 常見問題與解決方案

#### 問題：插件無法載入
- ✅ 確認 AutoCAD 版本為 2023
- ✅ 確認 .NET Framework 4.8 已安裝
- ✅ 使用正確的 v3 版本 DLL
- ✅ 檢查檔案路徑是否正確

#### 問題：CADAPI_WATCH 命令未知
- ✅ 確認插件已成功載入（使用 NETLOAD）
- ✅ 確認使用 v3 版本（不是 v1 或 v2）
- ✅ 查看 AutoCAD 命令行是否有錯誤訊息

#### 問題：命令執行無反應
1. 確認 CADAPI_WATCH 已啟動並顯示監視訊息
2. 確認使用 CLI.exe 寫入命令（不是手動編輯）
3. 檢查 commands.txt 檔案是否存在於正確位置
4. 查看 AutoCAD 命令行輸出是否有錯誤

#### 問題：繪圖不完整（缺少某些線條）
- ✅ 增加命令間隔時間（確保 1 秒以上）
- ✅ 使用延遲版腳本（名稱含 delay）
- ✅ 逐條執行命令進行測試
- ✅ 檢查命令格式是否正確

#### 問題：FileWatcher 不觸發
1. **必須**通過 CLI.exe 寫入
2. 檢查防毒軟體是否阻擋檔案監視
3. 確認 commands.txt 路徑正確且有寫入權限
4. 嘗試刪除 commands.txt 後重新啟動監視器

---

## 最佳實踐

### 批量繪圖建議

1. **使用 PowerShell 腳本**
   - 易於管理命令序列
   - 可加入錯誤處理
   - 支援日誌記錄

2. **命令延遲設定**
   ```powershell
   foreach ($cmd in $commands) {
       $cmd | & $cliPath
       Start-Sleep -Seconds 1  # 關鍵！
   }
   ```

3. **測試策略**
   - 先用少量命令測試
   - 確認無誤後再執行大批量
   - 保存成功的腳本供重複使用

### 專案組織建議

```
draw/
├── templates/          # 腳本模板
├── examples/           # 範例腳本
├── my_projects/        # 自定義專案
└── README.md          # 腳本說明
```

### 錯誤處理範例

```powershell
try {
    $cmd | & $cliPath
    Write-Host "✓ 執行成功: $cmd" -ForegroundColor Green
} catch {
    Write-Host "✗ 執行失敗: $cmd" -ForegroundColor Red
    Write-Host $_.Exception.Message
}
```

---

## 限制與展望

### 當前限制

1. **功能限制**
   - 基本圖形命令已實現（線、圓、弧、矩形、文字等）
   - 選擇和修改功能已完成
   - 圖層和顏色管理尚未實現

2. **通信限制**
   - 單向通信（無法獲取 AutoCAD 狀態）
   - 無法查詢圖形資訊
   - 沒有命令執行結果回饋

3. **性能限制**
   - 每個命令需要 1 秒延遲
   - 不適合即時互動應用
   - 大量命令執行較慢

### 未來可能的改進

1. **圖層和樣式管理**
   - 圖層創建與管理
   - 顏色和線型設定
   - 文字和標註樣式
   - 圖塊定義與管理

2. **增強功能**
   - 圖層管理
   - 顏色設定
   - 線型控制
   - 標註功能

3. **改進通信機制**
   - 雙向通信
   - 狀態查詢
   - 結果回饋
   - 錯誤處理

---

## 相關文檔

- **[README.md](../README.md)** - 專案總覽
- **[TOOLS.md](../TOOLS.md)** - 技術實現細節
- **[CHANGELOG.md](../CHANGELOG.md)** - 開發歷史記錄
- **[build.md](build.md)** - LLM 開發指南

---

## 快速參考卡

### 最常用命令
```bash
# AutoCAD 內
NETLOAD                    # 載入插件
CADAPI_WATCH              # 啟動監視
CADAPI_STOPWATCH          # 停止監視

# 終端內
cd {CAD_API根目錄}
powershell -ExecutionPolicy Bypass -File draw\draw_three_squares_delay.ps1
```

### 命令格式速查

#### 繪圖命令
```
DRAW LINE 0,0 1000 H              # 水平線
DRAW CIRCLE 500,500 300           # 圓形
DRAW RECTANGLE 0,0 1000,800       # 矩形
DRAW ARC 0,0 500 0 90             # 弧線
DRAW TEXT 100,100 50 "房間名稱"   # 文字
```

#### 選擇命令
```
SELECT ALL                        # 選擇所有
SELECT TYPE CIRCLE                # 選擇圓形
SELECT WINDOW 0,0 1000,1000       # 窗口選擇
SELECT LAST                       # 選擇最後物件
```

#### 修改命令
```
MOVE SELECTED 100,0               # 移動選中物件
COPY LAST 0,500 3                 # 複製3份
ROTATE SELECTED 0,0 45            # 旋轉45度
SCALE ALL 0,0 2.0                 # 放大2倍
```

---

最後更新：2025-07-26